doctype html
head
    title=user.display_name + "'s Settings"
    link(rel='stylesheet', href='/public/stylesheets/style.css')
    link(rel="stylesheet", href="/public/stylesheets/user/settings.css")
body
    include ../includes/head.pug
    +navbar-include(user)
    div(class="container")
        h1 Profile
        form(action="javascript:updateAccount()")
            label(for="profile_page") Profile Page
            a(id="profile_page" href="http://localhost:3000/user/" + user._id + "/" )
                | http://localhost:3000/user/
                span= user._id
                | /
            label(for="display_name") Display Name
            input(id="display_name" value=user.display_name type="text")
            input(type="submit" value="Update Profile")
    div(class="container")
        h1 Account
        form(action="javascript:updateAccount()")
            label(for="email") Email Address
            input(id="email" value=user.email type="email")
            label(for="email_list")= `I consent to receive emails from Project-9927`
            input(id="email_list" checked type="checkbox")
            input(type="submit" value="Update Account")
    div(class="container")
        h1 Online Status
        form(action="javascript:updateOnline()")
            label(for="public_visible") Allow users to find you by username?
            input(id="public_visible" type="checkbox")
            input(type="submit" value="Update Status")
    div(class="container")
        h1 Password
        form(action="javascript:updatePassword()")
            p(id="password_error" style="display: none; color: indianred;") Sorry, we couldn't update your password!
            label(for="current_password") Current Password:
            input(id="current_password" type="password" placeholder="Current password..")
            label(for="new_password") New Password (>6 characters):
            input(id="new_password" type="password" placeholder="New password..")
            label(for="confirm_password") Confirm Password:
            input(id="confirm_password" type="password" placeholder="Confirm password..")
            input(type="submit" value="Update Password")
script.
    document.getElementById('email_list').checked = #{user.email_list};
    document.getElementById('public_visible').checked = #{user.visible};

    async function updatePassword(){
        const currentPassword = document.getElementById('current_password').value || "";
        const newPassword = document.getElementById('new_password').value || "";
        const confirmPassword = document.getElementById('confirm_password').value || "";

        const checkPassword = await (await fetch('/api/user/checkpassword', {
            method: "GET",
            headers: {
                password: currentPassword
            }
        })).json();
        const change = checkPassword && newPassword === confirmPassword && newPassword.length >= 6;
        if(change){
            fetch('/api/user/changepassword', {method: "GET", headers: {password: newPassword}})
            location.replace('/');
        } else {
            document.getElementById('password_error').style.display = 'block';
        }
    }